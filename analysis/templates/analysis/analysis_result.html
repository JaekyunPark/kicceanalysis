{% extends 'surveys/base.html' %}
{% load static %}
{% load analysis_filters %}

{% block title %}Î∂ÑÏÑù Í≤∞Í≥º{% endblock %}

{% block extra_css %}
<style>
    .result-table {
        margin-bottom: 40px;
    }

    .result-title {
        background-color: #f8f9fa;
        padding: 15px;
        border-left: 4px solid #0d6efd;
        margin-bottom: 20px;
    }

    .analysis-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    .analysis-table th,
    .analysis-table td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: center;
        position: relative;
    }

    .analysis-table th {
        background-color: #e9ecef;
        font-weight: 600;
    }

    .analysis-table .row-header {
        text-align: left;
        background-color: #f8f9fa;
        font-weight: 500;
    }

    /* Í∏??çÏä§???¥ÌåÅ */
    .long-text {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: help;
        display: inline-block;
    }

    .long-text:hover::after {
        content: attr(data-full-text);
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: 100%;
        background-color: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        white-space: normal;
        z-index: 1000;
        min-width: 200px;
        max-width: 400px;
        font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        margin-bottom: 5px;
    }

    .long-text:hover::before {
        content: '';
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: 100%;
        border: 6px solid transparent;
        border-top-color: #333;
        z-index: 1001;
    }

    .analysis-table .total-row {
        background-color: #fff3cd;
        font-weight: 600;
    }

    .analysis-table .total-col {
        background-color: #fff3cd;
        font-weight: 600;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
        padding: 8px 12px;
        background-color: #f8f9fa;
        text-align: left;
    }

    .test-statistics {
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        padding: 10px;
        text-align: center;
        font-size: 0.9rem;
        margin-top: -1px;
    }

    .test-statistics strong {
        color: #0d6efd;
    }

    .export-buttons {
        margin: 20px 0;
    }

    .table-wrapper {
        overflow-x: auto;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Î∂ÑÏÑù Í≤∞Í≥º</h2>
        <div class="export-buttons">
            <button class="btn btn-info" onclick="copyTableToClipboard()">
                <i class="bi bi-clipboard"></i> ??Î≥µÏÇ¨
            </button>
            <button class="btn btn-success" onclick="exportToExcel()">
                <i class="bi bi-file-excel"></i> ExcelÎ°??¥Î≥¥?¥Í∏∞
            </button>
            <a href="{% url 'analysis:unified_analysis' %}?dataset_id={{ dataset_id }}" class="btn btn-secondary">
                ??Î∂ÑÏÑù
            </a>
        </div>
    </div>

    {% for analysis in result %}
    <div class="result-table">
        <div class="result-title">
            <h4>{% for label in analysis.row_labels %}{{ label }}{% if not forloop.last %}, {% endif %}{% endfor %} √ó {{
                analysis.col_label }}</h4>
            <p class="mb-0 text-muted">
                <small>??Î≥Ä?? {% for rv in analysis.row_variables %}{{ rv }}{% if not forloop.last %}, {% endif %}{%
                    endfor %} | ??Î≥Ä?? {{ analysis.col_var }}</small>
            </p>
        </div>

        {% if analysis.unified %}
        <!-- ?µÌï© Î∂ÑÏÑù Í≤∞Í≥º (ÎπàÎèÑ + Í∏∞Ïà†?µÍ≥Ñ) -->
        <div class="table-wrapper">
            <table class="analysis-table">
                <thead>
                    <tr>
                        <th>?µÍ≥Ñ??/th>
                        {% for col in analysis.unified.columns %}
                        <th>{{ col|truncate_with_tooltip:30 }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row_var_result in analysis.unified.row_var_results %}
                    {% for row in row_var_result.rows %}
                    <tr {% if row.label == 'Total' %}class="total-row" {% endif %}>
                        <td class="row-header">{{ row.label|truncate_with_tooltip:40 }}</td>
                        {% for value in row.values %}
                        <td>
                            {% if value is number %}
                            {{ value|floatformat:2 }}
                            {% else %}
                            {{ value }}
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}

                    <!-- Í≤Ä???µÍ≥Ñ??- Ïπ?Î∂ÑÎ¶¨ -->
                    {% if row_var_result.chi_square_test or row_var_result.descriptive_test %}
                    <tr>
                        <td class="row-header">Í≤Ä???µÍ≥Ñ??/td>

                        {% if analysis.unified.desc_col_count > 0 %}
                        <!-- ÎπàÎèÑ?Ä Í∏∞Ïà†?µÍ≥Ñ ?????àÎäî Í≤ΩÏö∞ -->
                        <!-- ÎπàÎèÑ ?ÅÏó≠: Í≥ÑÏ? ?¨Î???2Í∞????úÏô∏ -->
                        <td colspan="{% if analysis.unified.freq_col_count > 2 %}{{ analysis.unified.freq_col_count|add:'-2' }}{% else %}{{ analysis.unified.freq_col_count }}{% endif %}"
                            class="test-statistics">
                            {% if row_var_result.chi_square_test %}
                            {{ row_var_result.chi_square_test.formatted }}
                            {% endif %}
                        </td>
                        <!-- Í≥ÑÏ? ?¨Î???Ïπ?(Î≥ëÌï© ???? -->
                        <td></td>
                        <td></td>
                        <!-- Í∏∞Ïà†?µÍ≥Ñ ?ÅÏó≠ -->
                        <td colspan="{{ analysis.unified.desc_col_count }}" class="test-statistics">
                            {% if row_var_result.descriptive_test %}
                            {{ row_var_result.descriptive_test.formatted }}
                            {% endif %}
                        </td>
                        {% else %}
                        <!-- ÎπàÎèÑÎß??àÎäî Í≤ΩÏö∞ - Í≥ÑÏ? ?¨Î????úÏô∏?òÍ≥† Î≥ëÌï© -->
                        <td colspan="{% if analysis.unified.freq_col_count > 2 %}{{ analysis.unified.freq_col_count|add:'-2' }}{% else %}{{ analysis.unified.freq_col_count }}{% endif %}"
                            class="test-statistics">
                            {% if row_var_result.chi_square_test %}
                            {{ row_var_result.chi_square_test.formatted }}
                            {% endif %}
                        </td>
                        <!-- Í≥ÑÏ? ?¨Î???Ïπ?(Î≥ëÌï© ???? -->
                        <td></td>
                        <td></td>
                        {% endif %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if analysis.frequency %}
        <!-- ÎπàÎèÑ Î∂ÑÏÑù Í≤∞Í≥º -->
        <div class="table-wrapper">
            <table class="analysis-table">
                <thead>
                    <tr>
                        <th>??% (Row %)</th>
                        {% for col in analysis.frequency.row_var_results.0.tables.0.data.columns %}
                        <th {% if col == 'Total' %}class="total-col" {% endif %}>{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row_result in analysis.frequency.row_var_results %}
                    {% for table in row_result.tables %}
                    {% for row_idx in table.data.index %}
                    <tr {% if row_idx == 'Total' %}class="total-row" {% endif %}>
                        <td class="row-header">{{ row_idx|truncate_with_tooltip:40 }}</td>
                        {% with row_index=forloop.counter0 %}
                        {% for value in table.data.data|index:row_index %}
                        <td {% if table.data.columns|index:forloop.counter0 == 'Total' %}class="total-col" {% endif %}>
                            {% if table.data.columns|index:forloop.counter0 == '?¨Î??? %}
                            {# ?¨Î??òÎäî Í∑∏Î?Î°??úÏãú #}
                            {{ value }}
                            {% elif table.type == 'count' %}
                            {{ value|floatformat:0 }}
                            {% else %}
                            {# Î∞±Î∂Ñ??- Í≥??¥ÎèÑ ?¨Ìï® #}
                            {% if row_result.percent_symbol %}
                            {{ value|floatformat:1 }}%
                            {% else %}
                            {{ value|floatformat:1 }}
                            {% endif %}
                            {% endif %}
                        </td>
                        {% endfor %}
                        {% endwith %}
                    </tr>
                    {% endfor %}
                    {% endfor %}

                    <!-- ????Î≥Ä?òÏùò Ïπ¥Ïù¥?úÍ≥± Í≤Ä??Í≤∞Í≥º (?åÏù¥Î∏????âÏúºÎ°??ΩÏûÖ) -->
                    {% if row_result.chi_square %}
                    <tr>
                        <td class="row-header">Í≤Ä???µÍ≥Ñ??/td>
                        <!-- Í≥ÑÏ? ?¨Î???2Í∞????úÏô∏?òÍ≥† Î≥ëÌï© -->
                        <td colspan="{% if row_result.tables.0.data.columns|length > 2 %}{{ row_result.tables.0.data.columns|length|add:'-2' }}{% else %}{{ row_result.tables.0.data.columns|length }}{% endif %}"
                            class="test-statistics">
                            {{ row_result.chi_square.formatted }}
                        </td>
                        <!-- Í≥ÑÏ? ?¨Î???Ïπ?(Î≥ëÌï© ???? -->
                        <td></td>
                        <td></td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if analysis.descriptive %}
        <!-- Í∏∞Ïà†?µÍ≥Ñ Í≤∞Í≥º -->
        <div class="table-wrapper">
            {% if analysis.descriptive.error %}
            <div class="alert alert-warning">
                {{ analysis.descriptive.error }}
            </div>
            {% else %}
            <table class="analysis-table">
                <thead>
                    <tr>
                        <th>?µÍ≥Ñ??/th>
                        {% for col in analysis.descriptive.columns %}
                        <th>{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row_var_result in analysis.descriptive.row_var_results %}
                    {% for row in row_var_result.rows %}
                    <tr {% if row.label == 'Total' %}class="total-row" {% endif %}>
                        <td class="row-header">{{ row.label|truncate_with_tooltip:40 }}</td>
                        {% for value in row.values %}
                        <td>{{ value|floatformat:2 }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}

                    <!-- ????Î≥Ä?òÏùò Í≤Ä??Í≤∞Í≥º (?åÏù¥Î∏????âÏúºÎ°??ΩÏûÖ) -->
                    {% if row_var_result.statistical_test %}
                    <tr>
                        <td class="row-header">Í≤Ä???µÍ≥Ñ??/td>
                        <td colspan="{{ analysis.descriptive.columns|length }}" class="test-statistics">
                            {{ row_var_result.statistical_test.formatted }}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            {% endif %} {# descriptive.error??else Ï¢ÖÎ£å #}
        </div>
        {% endif %} {# analysis.descriptive Ï¢ÖÎ£å #}
    </div>
    {% endfor %} {# result loop Ï¢ÖÎ£å #}
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function copyTableToClipboard() {
        try {
            // Î™®Îì† Î∂ÑÏÑù Í≤∞Í≥º ?åÏù¥Î∏??úÌöå
            const resultTables = document.querySelectorAll('.result-table');

            if (resultTables.length === 0) {
                alert('Î≥µÏÇ¨???åÏù¥Î∏îÏù¥ ?ÜÏäµ?àÎã§.');
                return;
            }

            let htmlContent = '<html><body>';

            resultTables.forEach((resultTable, index) => {
                // ?úÎ™© Ï∂îÍ?
                const title = resultTable.querySelector('.result-title h4');
                if (title) {
                    htmlContent += '<h4>' + title.textContent.trim() + '</h4>';
                }

                // ?åÏù¥Î∏?Î≥µÏÇ¨ (?êÎ≥∏ HTML Í∑∏Î?Î°?
                const tables = resultTable.querySelectorAll('.analysis-table');
                tables.forEach(table => {
                    // ?åÏù¥Î∏?Î≥µÏ†ú
                    const clonedTable = table.cloneNode(true);

                    // ?§Ì????∏Îùº?∏ÏúºÎ°?Ï∂îÍ?
                    clonedTable.setAttribute('border', '1');
                    clonedTable.style.borderCollapse = 'collapse';
                    clonedTable.style.width = 'auto';

                    // Î™®Îì† ?Ä???åÎëêÎ¶??§Ì???Ï∂îÍ?
                    const allCells = clonedTable.querySelectorAll('th, td');
                    allCells.forEach(cell => {
                        cell.style.border = '1px solid black';
                        cell.style.padding = '4px 8px';

                        // Í∏∞Ï°¥ ?¥Îûò??Í∏∞Î∞ò ?§Ì??ºÏùÑ ?∏Îùº?∏ÏúºÎ°?Î≥Ä??                        if (cell.classList.contains('row-header')) {
                            cell.style.fontWeight = 'bold';
                        }
                        if (cell.classList.contains('total-row') || cell.classList.contains('total-col')) {
                            cell.style.backgroundColor = '#f0f0f0';
                            cell.style.fontWeight = 'bold';
                        }
                        if (cell.classList.contains('test-statistics')) {
                            cell.style.fontStyle = 'italic';
                            cell.style.textAlign = 'center';
                        }
                        if (cell.tagName === 'TH') {
                            cell.style.backgroundColor = '#d3d3d3';
                            cell.style.fontWeight = 'bold';
                            cell.style.textAlign = 'center';
                        }
                    });

                    htmlContent += clonedTable.outerHTML;
                    htmlContent += '<br>';
                });

                if (index < resultTables.length - 1) {
                    htmlContent += '<hr>';
                }
            });

            htmlContent += '</body></html>';

            // ?¥Î¶ΩÎ≥¥Îìú??Î≥µÏÇ¨
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const clipboardItem = new ClipboardItem({ 'text/html': blob });

            navigator.clipboard.write([clipboardItem]).then(() => {
                showCopySuccess();
            }).catch(err => {
                console.error('HTML Î≥µÏÇ¨ ?§Ìå®, ?çÏä§?∏Î°ú ?úÎèÑ:', err);
                // Fallback: ?çÏä§?∏Î°ú Î≥µÏÇ¨
                fallbackTextCopy();
            });

        } catch (error) {
            console.error('Î≥µÏÇ¨ ?§Î•ò:', error);
            // Fallback: ?çÏä§?∏Î°ú Î≥µÏÇ¨
            fallbackTextCopy();
        }
    }

    function fallbackTextCopy() {
        try {
            let textData = '';

            const resultTables = document.querySelectorAll('.result-table');

            resultTables.forEach((resultTable, index) => {
                const title = resultTable.querySelector('.result-title h4');
                if (title) {
                    textData += title.textContent.trim() + '\n\n';
                }

                const tables = resultTable.querySelectorAll('.analysis-table');

                tables.forEach(table => {
                    const rows = table.querySelectorAll('tr');

                    // Î≥ëÌï©???Ä Ï∂îÏ†Å
                    const cellMatrix = [];

                    rows.forEach((row, rowIndex) => {
                        if (!cellMatrix[rowIndex]) {
                            cellMatrix[rowIndex] = [];
                        }

                        const cells = row.querySelectorAll('th, td');
                        let colIndex = 0;

                        cells.forEach(cell => {
                            while (cellMatrix[rowIndex][colIndex] !== undefined) {
                                colIndex++;
                            }

                            const colspan = parseInt(cell.getAttribute('colspan') || '1');
                            const rowspan = parseInt(cell.getAttribute('rowspan') || '1');
                            let cellText = cell.textContent.trim().replace(/\s+/g, ' ');

                            for (let r = 0; r < rowspan; r++) {
                                if (!cellMatrix[rowIndex + r]) {
                                    cellMatrix[rowIndex + r] = [];
                                }
                                for (let c = 0; c < colspan; c++) {
                                    cellMatrix[rowIndex + r][colIndex + c] = (r === 0 && c === 0) ? cellText : '';
                                }
                            }

                            colIndex += colspan;
                        });
                    });

                    cellMatrix.forEach(row => {
                        textData += row.join('\t') + '\n';
                    });

                    textData += '\n';
                });

                if (index < resultTables.length - 1) {
                    textData += '---\n\n';
                }
            });

            // ?çÏä§??Î≥µÏÇ¨
            navigator.clipboard.writeText(textData).then(() => {
                showCopySuccess();
            }).catch(err => {
                console.error('?çÏä§??Î≥µÏÇ¨???§Ìå®:', err);
                // ÏµúÌõÑ???òÎã®: execCommand
                const textarea = document.createElement('textarea');
                textarea.value = textData;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();

                try {
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showCopySuccess();
                } catch (e) {
                    document.body.removeChild(textarea);
                    alert('Î≥µÏÇ¨???§Ìå®?àÏäµ?àÎã§. Î∏åÎùº?∞Ï?Í∞Ä Î≥µÏÇ¨ Í∏∞Îä•??ÏßÄ?êÌïòÏßÄ ?äÏäµ?àÎã§.');
                }
            });

        } catch (error) {
            console.error('Fallback Î≥µÏÇ¨ ?§Î•ò:', error);
            alert('Î≥µÏÇ¨ Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§: ' + error.message);
        }
    }

    function fallbackCopy(text) {
        try {
            // ?ÑÏãú textarea ?ùÏÑ±
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '0';
            document.body.appendChild(textarea);

            // ?çÏä§???†ÌÉù Î∞?Î≥µÏÇ¨
            textarea.focus();
            textarea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    throw new Error('execCommand failed');
                }
            } catch (err) {
                console.error('execCommand ?§Ìå®:', err);
                // Î∞©Î≤ï 3: ?òÎèô ?†ÌÉù ?àÎÇ¥
                textarea.style.position = 'static';
                textarea.style.width = '100%';
                textarea.style.height = '200px';

                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '50%';
                modal.style.left = '50%';
                modal.style.transform = 'translate(-50%, -50%)';
                modal.style.background = 'white';
                modal.style.padding = '20px';
                modal.style.border = '2px solid #333';
                modal.style.zIndex = '10000';
                modal.style.maxWidth = '80%';
                modal.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';

                modal.innerHTML = `
                <h4>Î≥µÏÇ¨???∞Ïù¥??/h4>
                <p>?ÑÎûò ?çÏä§?∏Î? ?†ÌÉù?òÏó¨ Î≥µÏÇ¨?òÏÑ∏??(Ctrl+C ?êÎäî Cmd+C):</p>
                <button onclick="this.parentElement.remove()" style="float: right; margin-bottom: 10px;">?´Í∏∞</button>
                <div style="clear: both;"></div>
            `;
                modal.appendChild(textarea);

                document.body.appendChild(modal);
                textarea.select();
            } finally {
                // textareaÍ∞Ä Î™®Îã¨???ÜÏúºÎ©??úÍ±∞
                if (textarea.parentElement === document.body) {
                    document.body.removeChild(textarea);
                }
            }

        } catch (error) {
            console.error('Fallback Î≥µÏÇ¨ ?§Ìå®:', error);
            alert('?¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Î•?ÏßÄ?êÌïòÏßÄ ?äÎäî Î∏åÎùº?∞Ï??ÖÎãà?? ?òÎèô?ºÎ°ú Î≥µÏÇ¨?¥Ï£º?∏Ïöî.');
        }
    }

    function showCopySuccess() {
        // Í∞ÑÎã®???åÎ¶º ?úÏãú
        alert('???åÏù¥Î∏îÏù¥ ?¥Î¶ΩÎ≥¥Îìú??Î≥µÏÇ¨?òÏóà?µÎãà??\n\nExcel ?êÎäî Google Sheets??Î∂ôÏó¨?£Í∏∞ ?òÏÑ∏??');
    }

    function exportToExcel() {
        console.log('Export button clicked');

        // ???ùÏÑ± Î∞??úÏ∂ú
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "analysis:export_excel" %}';
        form.style.display = 'none';

        // CSRF ?†ÌÅ∞ (Ïø†ÌÇ§?êÏÑú Í∞Ä?∏Ïò§Í∏?
        const csrfToken = getCookie('csrftoken');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        // ?∞Ïù¥?∞ÏÖã
        const datasetInput = document.createElement('input');
        datasetInput.type = 'hidden';
        datasetInput.name = 'dataset_id';
        datasetInput.value = '{{ dataset_id }}';
        form.appendChild(datasetInput);

        // ÏΩîÎìúÎ∂?        {% if codebook_id %}
        const codebookInput = document.createElement('input');
        codebookInput.type = 'hidden';
        codebookInput.name = 'codebook_id';
        codebookInput.value = '{{ codebook_id }}';
        form.appendChild(codebookInput);
        {% endif %}

        // ??Î≥Ä?òÎì§
        {% for rv in row_variables %}
        const rowVarInput{{ forloop.counter }} = document.createElement('input');
        rowVarInput{{ forloop.counter }}.type = 'hidden';
        rowVarInput{{ forloop.counter }}.name = 'row_variables[]';
        rowVarInput{{ forloop.counter }}.value = '{{ rv }}';
    form.appendChild(rowVarInput{{ forloop.counter }});
    {% endfor %}

    {% for cv in col_variables %}
    const colVarInput{{ forloop.counter }} = document.createElement('input');
    colVarInput{{ forloop.counter }}.type = 'hidden';
    colVarInput{{ forloop.counter }}.name = 'col_variables[]';
    colVarInput{{ forloop.counter }}.value = '{{ cv }}';
    form.appendChild(colVarInput{{ forloop.counter }});
    {% endfor %}

    // ?µÍ≥Ñ???§Ï†ï (JSON???§Ïãú Í∞úÎ≥Ñ ?ÑÎìúÎ°?
    try {
        const colStatsJson = '{{ col_statistics|escapejs }}';
        const colStats = JSON.parse(colStatsJson);

        for (const [colVar, stats] of Object.entries(colStats)) {
            for (const [statType, enabled] of Object.entries(stats)) {
                if (enabled) {
                    const statInput = document.createElement('input');
                    statInput.type = 'hidden';
                    statInput.name = `col_statistics[${colVar}][${statType}]`;
                    statInput.value = 'on';
                    form.appendChild(statInput);
                }
            }
        }
    } catch (e) {
        console.error('Error parsing col_statistics:', e);
    }

    // ?µÏÖò
    {% if show_total %}
    const totalInput = document.createElement('input');
    totalInput.type = 'hidden';
    totalInput.name = 'show_total';
    totalInput.value = 'on';
    form.appendChild(totalInput);
    {% endif %}

    {% if auto_test %}
    const testInput = document.createElement('input');
    testInput.type = 'hidden';
    testInput.name = 'auto_test';
    testInput.value = 'on';
    form.appendChild(testInput);
    {% endif %}

    // ?úÏãú ?ïÏãù ?µÏÖò
    const percentInput = document.createElement('input');
    percentInput.type = 'hidden';
    percentInput.name = 'percent_symbol';
    percentInput.value = '{{ percent_symbol }}';
    form.appendChild(percentInput);

    const decimalsInput = document.createElement('input');
    decimalsInput.type = 'hidden';
    decimalsInput.name = 'mean_decimals';
    decimalsInput.value = '{{ mean_decimals }}';
    form.appendChild(decimalsInput);

    // Ïπ¥Ïù¥?úÍ≥± ?úÏãú ?ïÏãù
    {% if show_chi_label %} form.appendChild(createInput('show_chi_label', 'on')); {% endif %}
    {% if show_chi_value %} form.appendChild(createInput('show_chi_value', 'on')); {% endif %}
    {% if show_chi_df %} form.appendChild(createInput('show_chi_df', 'on')); {% endif %}
    {% if show_chi_stars %} form.appendChild(createInput('show_chi_stars', 'on')); {% endif %}
    {% if show_chi_pvalue %} form.appendChild(createInput('show_chi_pvalue', 'on')); {% endif %}

    // t/F Í≤Ä???úÏãú ?ïÏãù
    {% if show_tf_label %} form.appendChild(createInput('show_tf_label', 'on')); {% endif %}
    {% if show_tf_value %} form.appendChild(createInput('show_tf_value', 'on')); {% endif %}
    {% if show_tf_df %} form.appendChild(createInput('show_tf_df', 'on')); {% endif %}
    {% if show_tf_stars %} form.appendChild(createInput('show_tf_stars', 'on')); {% endif %}
    {% if show_tf_pvalue %} form.appendChild(createInput('show_tf_pvalue', 'on')); {% endif %}

    document.body.appendChild(form);
    form.submit();

    // ???úÍ±∞???ΩÍ∞Ñ ÏßÄ??    setTimeout(() => {
        document.body.removeChild(form);
    }, 1000);
    }

    // ?¨Ìçº ?®Ïàò
    function createInput(name, value) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        return input;
    }
</script>
{% endblock %}
