{% extends 'surveys/base.html' %}
{% load static %}
{% load analysis_filters %}

{% block title %}분석 결과{% endblock %}

{% block extra_css %}
<style>
    .result-table {
        margin-bottom: 40px;
    }

    .result-title {
        background-color: #f8f9fa;
        padding: 15px;
        border-left: 4px solid #0d6efd;
        margin-bottom: 20px;
    }

    .analysis-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    .analysis-table th,
    .analysis-table td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: center;
        position: relative;
    }

    .analysis-table th {
        background-color: #e9ecef;
        font-weight: 600;
    }

    .analysis-table .row-header {
        text-align: left;
        background-color: #f8f9fa;
        font-weight: 500;
    }

    /* 긴 텍스트 툴팁 */
    .long-text {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: help;
        display: inline-block;
    }

    .long-text:hover::after {
        content: attr(data-full-text);
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: 100%;
        background-color: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        white-space: normal;
        z-index: 1000;
        min-width: 200px;
        max-width: 400px;
        font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        margin-bottom: 5px;
    }

    .long-text:hover::before {
        content: '';
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: 100%;
        border: 6px solid transparent;
        border-top-color: #333;
        z-index: 1001;
    }

    .analysis-table .total-row {
        background-color: #fff3cd;
        font-weight: 600;
    }

    .analysis-table .total-col {
        background-color: #fff3cd;
        font-weight: 600;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
        padding: 8px 12px;
        background-color: #f8f9fa;
        text-align: left;
    }

    .test-statistics {
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        padding: 10px;
        text-align: center;
        font-size: 0.9rem;
        margin-top: -1px;
    }

    .test-statistics strong {
        color: #0d6efd;
    }

    .export-buttons {
        margin: 20px 0;
    }

    .table-wrapper {
        overflow-x: auto;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>분석 결과</h2>
        <div class="export-buttons">
            <button class="btn btn-info" onclick="copyTableToClipboard()">
                <i class="bi bi-clipboard"></i> 표 복사
            </button>
            <button class="btn btn-success" onclick="exportToExcel()">
                <i class="bi bi-file-excel"></i> Excel로 내보내기
            </button>
            <a href="{% url 'analysis:unified_analysis' %}?dataset_id={{ dataset_id }}" class="btn btn-secondary">
                새 분석
            </a>
        </div>
    </div>

    {% for analysis in result %}
    <div class="result-table">
        <div class="result-title">
            <h4>{% for label in analysis.row_labels %}{{ label }}{% if not forloop.last %}, {% endif %}{% endfor %} × {{ analysis.col_label }}</h4>
            <p class="mb-0 text-muted">
                <small>행 변수: {% for rv in analysis.row_variables %}{{ rv }}{% if not forloop.last %}, {% endif %}{% endfor %} | 열 변수: {{ analysis.col_var }}</small>
            </p>
        </div>

        {% if analysis.unified %}
        <!-- 통합 분석 결과 (빈도 + 기술통계) -->
        <div class="table-wrapper">
            <table class="analysis-table">
                <thead>
                    <tr>
                        <th>통계량</th>
                        {% for col in analysis.unified.columns %}
                        <th>{{ col|truncate_with_tooltip:30 }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row_var_result in analysis.unified.row_var_results %}
                    {% for row in row_var_result.rows %}
                    <tr {% if row.label == 'Total' %}class="total-row" {% endif %}>
                        <td class="row-header">{{ row.label|truncate_with_tooltip:40 }}</td>
                        {% for value in row.values %}
                        <td>
                            {% if value is number %}
                            {{ value|floatformat:2 }}
                            {% else %}
                            {{ value }}
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}

                    <!-- 검정 통계량 - 칸 분리 -->
                    {% if row_var_result.chi_square_test or row_var_result.descriptive_test %}
                    <tr>
                        <td class="row-header">검정 통계량</td>

                        {% if analysis.unified.desc_col_count > 0 %}
                        <!-- 빈도와 기술통계 둘 다 있는 경우 -->
                        <!-- 빈도 영역: 계와 사례수 2개 열 제외 -->
                        <td colspan="{% if analysis.unified.freq_col_count > 2 %}{{ analysis.unified.freq_col_count|add:'-2' }}{% else %}{{ analysis.unified.freq_col_count }}{% endif %}"
                            class="test-statistics">
                            {% if row_var_result.chi_square_test %}
                            {{ row_var_result.chi_square_test.formatted }}
                            {% endif %}
                        </td>
                        <!-- 계와 사례수 칸 (병합 안 함) -->
                        <td></td>
                        <td></td>
                        <!-- 기술통계 영역 -->
                        <td colspan="{{ analysis.unified.desc_col_count }}" class="test-statistics">
                            {% if row_var_result.descriptive_test %}
                            {{ row_var_result.descriptive_test.formatted }}<br>
                            {# {% if row_var_result.descriptive_test.levene_formatted %} #}
                            {# <small class="text-muted" style="font-size: 0.8em;">Levene: {{ row_var_result.descriptive_test.levene_formatted }}</small> #}
                            {# {% endif %} #}
                            {% endif %}
                        </td>
                        {% else %}
                        <!-- 빈도만 있는 경우 - 계와 사례수 제외하고 병합 -->
                        <td colspan="{% if analysis.unified.freq_col_count > 2 %}{{ analysis.unified.freq_col_count|add:'-2' }}{% else %}{{ analysis.unified.freq_col_count }}{% endif %}"
                            class="test-statistics">
                            {% if row_var_result.chi_square_test %}
                            {{ row_var_result.chi_square_test.formatted }}
                            {% endif %}
                        </td>
                        <!-- 계와 사례수 칸 (병합 안 함) -->
                        <td></td>
                        <td></td>
                        {% endif %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if analysis.frequency %}
        <!-- 빈도 분석 결과 -->
        <div class="table-wrapper">
            <table class="analysis-table">
                <thead>
                    <tr>
                        <th>행 % (Row %)</th>
                        {% for col in analysis.frequency.row_var_results.0.tables.0.data.columns %}
                        <th {% if col == 'Total' %}class="total-col" {% endif %}>{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row_result in analysis.frequency.row_var_results %}
                    {% for table in row_result.tables %}
                    {% for row_idx in table.data.index %}
                    <tr {% if row_idx == 'Total' %}class="total-row" {% endif %}>
                        <td class="row-header">{{ row_idx|truncate_with_tooltip:40 }}</td>
                        {% with row_index=forloop.counter0 %}
                        {% for value in table.data.data|index:row_index %}
                        <td {% if table.data.columns|index:forloop.counter0 == 'Total' %}class="total-col" {% endif %}>
                            {% if table.data.columns|index:forloop.counter0 == '사례수' %}
                            {# 사례수는 그대로 표시 #}
                            {{ value }}
                            {% elif table.type == 'count' %}
                            {{ value|floatformat:0 }}
                            {% else %}
                            {# 백분율 - 계 열도 포함 #}
                            {% if row_result.percent_symbol %}
                            {{ value|floatformat:1 }}%
                            {% else %}
                            {{ value|floatformat:1 }}
                            {% endif %}
                            {% endif %}
                        </td>
                        {% endfor %}
                        {% endwith %}
                    </tr>
                    {% endfor %}
                    {% endfor %}

                    <!-- 이 행 변수의 카이제곱 검정 결과 (테이블 내 행으로 삽입) -->
                    {% if row_result.chi_square %}
                    <tr>
                        <td class="row-header">검정 통계량</td>
                        <!-- 계와 사례수 2개 열 제외하고 병합 -->
                        <td colspan="{% if row_result.tables.0.data.columns|length > 2 %}{{ row_result.tables.0.data.columns|length|add:'-2' }}{% else %}{{ row_result.tables.0.data.columns|length }}{% endif %}"
                            class="test-statistics">
                            {{ row_result.chi_square.formatted }}
                        </td>
                        <!-- 계와 사례수 칸 (병합 안 함) -->
                        <td></td>
                        <td></td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if analysis.descriptive %}
        <!-- 기술통계 결과 -->
        <div class="table-wrapper">
            {% if analysis.descriptive.error %}
            <div class="alert alert-warning">
                {{ analysis.descriptive.error }}
            </div>
            {% else %}
            <table class="analysis-table">
                <thead>
                    <tr>
                        <th>통계량</th>
                        {% for col in analysis.descriptive.columns %}
                        <th>{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row_var_result in analysis.descriptive.row_var_results %}
                    {% for row in row_var_result.rows %}
                    <tr {% if row.label == 'Total' %}class="total-row" {% endif %}>
                        <td class="row-header">{{ row.label|truncate_with_tooltip:40 }}</td>
                        {% for value in row.values %}
                        <td>{{ value|floatformat:2 }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}

                    <!-- 이 행 변수의 검정 결과 (테이블 내 행으로 삽입) -->
                    {% if row_var_result.statistical_test %}
                    <tr>
                        <td class="row-header">검정 통계량</td>
                        <td colspan="{{ analysis.descriptive.columns|length }}" class="test-statistics">
                            {{ row_var_result.statistical_test.formatted }}<br>
                            {# {% if row_var_result.statistical_test.levene_formatted %} #}
                            {# <small class="text-muted" style="font-size: 0.8em;">Levene: {{
                                row_var_result.statistical_test.levene_formatted }}</small> #}
                            {# {% endif %} #}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            {% endif %} {# descriptive.error의 else 종료 #}
        </div>
        {% endif %} {# analysis.descriptive 종료 #}
    </div>
    {% endfor %} {# result loop 종료 #}
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function copyTableToClipboard() {
        try {
            // 모든 분석 결과 테이블 순회
            const resultTables = document.querySelectorAll('.result-table');

            if (resultTables.length === 0) {
                alert('복사할 테이블이 없습니다.');
                return;
            }

            let htmlContent = '<html><body>';

            resultTables.forEach((resultTable, index) => {
                // 제목 추가
                const title = resultTable.querySelector('.result-title h4');
                if (title) {
                    htmlContent += '<h4>' + title.textContent.trim() + '</h4>';
                }

                // 테이블 복사 (원본 HTML 그대로)
                const tables = resultTable.querySelectorAll('.analysis-table');
                tables.forEach(table => {
                    // 테이블 복제
                    const clonedTable = table.cloneNode(true);

                    // 스타일 인라인으로 추가
                    clonedTable.setAttribute('border', '1');
                    clonedTable.style.borderCollapse = 'collapse';
                    clonedTable.style.width = 'auto';

                    // 모든 셀에 테두리 스타일 추가
                    const allCells = clonedTable.querySelectorAll('th, td');
                    allCells.forEach(cell => {
                        cell.style.border = '1px solid black';
                        cell.style.padding = '4px 8px';

                        // 기존 클래스 기반 스타일을 인라인으로 변환
                        if (cell.classList.contains('row-header')) {
                            cell.style.fontWeight = 'bold';
                        }
                        if (cell.classList.contains('total-row') || cell.classList.contains('total-col')) {
                            cell.style.backgroundColor = '#f0f0f0';
                            cell.style.fontWeight = 'bold';
                        }
                        if (cell.classList.contains('test-statistics')) {
                            cell.style.fontStyle = 'italic';
                            cell.style.textAlign = 'center';
                        }
                        if (cell.tagName === 'TH') {
                            cell.style.backgroundColor = '#d3d3d3';
                            cell.style.fontWeight = 'bold';
                            cell.style.textAlign = 'center';
                        }
                    });

                    htmlContent += clonedTable.outerHTML;
                    htmlContent += '<br>';
                });

                if (index < resultTables.length - 1) {
                    htmlContent += '<hr>';
                }
            });

            htmlContent += '</body></html>';

            // 클립보드에 복사
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const clipboardItem = new ClipboardItem({ 'text/html': blob });

            navigator.clipboard.write([clipboardItem]).then(() => {
                showCopySuccess();
            }).catch(err => {
                console.error('HTML 복사 실패, 텍스트로 시도:', err);
                // Fallback: 텍스트로 복사
                fallbackTextCopy();
            });

        } catch (error) {
            console.error('복사 오류:', error);
            // Fallback: 텍스트로 복사
            fallbackTextCopy();
        }
    }

    function fallbackTextCopy() {
        try {
            let textData = '';

            const resultTables = document.querySelectorAll('.result-table');

            resultTables.forEach((resultTable, index) => {
                const title = resultTable.querySelector('.result-title h4');
                if (title) {
                    textData += title.textContent.trim() + '\n\n';
                }

                const tables = resultTable.querySelectorAll('.analysis-table');

                tables.forEach(table => {
                    const rows = table.querySelectorAll('tr');

                    // 병합된 셀 추적
                    const cellMatrix = [];

                    rows.forEach((row, rowIndex) => {
                        if (!cellMatrix[rowIndex]) {
                            cellMatrix[rowIndex] = [];
                        }

                        const cells = row.querySelectorAll('th, td');
                        let colIndex = 0;

                        cells.forEach(cell => {
                            while (cellMatrix[rowIndex][colIndex] !== undefined) {
                                colIndex++;
                            }

                            const colspan = parseInt(cell.getAttribute('colspan') || '1');
                            const rowspan = parseInt(cell.getAttribute('rowspan') || '1');
                            let cellText = cell.textContent.trim().replace(/\s+/g, ' ');

                            for (let r = 0; r < rowspan; r++) {
                                if (!cellMatrix[rowIndex + r]) {
                                    cellMatrix[rowIndex + r] = [];
                                }
                                for (let c = 0; c < colspan; c++) {
                                    cellMatrix[rowIndex + r][colIndex + c] = (r === 0 && c === 0) ? cellText : '';
                                }
                            }

                            colIndex += colspan;
                        });
                    });

                    cellMatrix.forEach(row => {
                        textData += row.join('\t') + '\n';
                    });

                    textData += '\n';
                });

                if (index < resultTables.length - 1) {
                    textData += '---\n\n';
                }
            });

            // 텍스트 복사
            navigator.clipboard.writeText(textData).then(() => {
                showCopySuccess();
            }).catch(err => {
                console.error('텍스트 복사도 실패:', err);
                // 최후의 수단: execCommand
                const textarea = document.createElement('textarea');
                textarea.value = textData;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();

                try {
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showCopySuccess();
                } catch (e) {
                    document.body.removeChild(textarea);
                    alert('복사에 실패했습니다. 브라우저가 복사 기능을 지원하지 않습니다.');
                }
            });

        } catch (error) {
            console.error('Fallback 복사 오류:', error);
            alert('복사 중 오류가 발생했습니다: ' + error.message);
        }
    }

    function fallbackCopy(text) {
        try {
            // 임시 textarea 생성
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '0';
            document.body.appendChild(textarea);

            // 텍스트 선택 및 복사
            textarea.focus();
            textarea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    throw new Error('execCommand failed');
                }
            } catch (err) {
                console.error('execCommand 실패:', err);
                // 방법 3: 수동 선택 안내
                textarea.style.position = 'static';
                textarea.style.width = '100%';
                textarea.style.height = '200px';

                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '50%';
                modal.style.left = '50%';
                modal.style.transform = 'translate(-50%, -50%)';
                modal.style.background = 'white';
                modal.style.padding = '20px';
                modal.style.border = '2px solid #333';
                modal.style.zIndex = '10000';
                modal.style.maxWidth = '80%';
                modal.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';

                modal.innerHTML = `
                <h4>복사할 데이터</h4>
                <p>아래 텍스트를 선택하여 복사하세요 (Ctrl+C 또는 Cmd+C):</p>
                <button onclick="this.parentElement.remove()" style="float: right; margin-bottom: 10px;">닫기</button>
                <div style="clear: both;"></div>
            `;
                modal.appendChild(textarea);

                document.body.appendChild(modal);
                textarea.select();
            } finally {
                // textarea가 모달에 없으면 제거
                if (textarea.parentElement === document.body) {
                    document.body.removeChild(textarea);
                }
            }

        } catch (error) {
            console.error('Fallback 복사 실패:', error);
            alert('클립보드 복사를 지원하지 않는 브라우저입니다. 수동으로 복사해주세요.');
        }
    }

    function showCopySuccess() {
        // 간단한 알림 표시
        alert('✓ 테이블이 클립보드에 복사되었습니다!\n\nExcel 또는 Google Sheets에 붙여넣기 하세요.');
    }

    function exportToExcel() {
        console.log('Export button clicked');

        // 폼 생성 및 제출
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "analysis:export_excel" %}';
        form.style.display = 'none';

        // CSRF 토큰 (쿠키에서 가져오기)
        const csrfToken = getCookie('csrftoken');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        // 데이터셋
        const datasetInput = document.createElement('input');
        datasetInput.type = 'hidden';
        datasetInput.name = 'dataset_id';
        datasetInput.value = '{{ dataset_id }}';
        form.appendChild(datasetInput);

        // 코드북
        {% if codebook_id %}
        const codebookInput = document.createElement('input');
        codebookInput.type = 'hidden';
        codebookInput.name = 'codebook_id';
        codebookInput.value = '{{ codebook_id }}';
        form.appendChild(codebookInput);
        {% endif %}

        // 행 변수들
        {% for rv in row_variables %}
        const rowVarInput{{ forloop.counter }} = document.createElement('input');
        rowVarInput{{ forloop.counter }}.type = 'hidden';
        rowVarInput{{ forloop.counter }}.name = 'row_variables[]';
        rowVarInput{{ forloop.counter }}.value = '{{ rv }}';
    form.appendChild(rowVarInput{{ forloop.counter }});
    {% endfor %}

    {% for cv in col_variables %}
    const colVarInput{{ forloop.counter }} = document.createElement('input');
    colVarInput{{ forloop.counter }}.type = 'hidden';
    colVarInput{{ forloop.counter }}.name = 'col_variables[]';
    colVarInput{{ forloop.counter }}.value = '{{ cv }}';
    form.appendChild(colVarInput{{ forloop.counter }});
    {% endfor %}

    // 통계량 설정 (JSON을 다시 개별 필드로)
    try {
        const colStatsJson = '{{ col_statistics|escapejs }}';
        const colStats = JSON.parse(colStatsJson);

        for (const [colVar, stats] of Object.entries(colStats)) {
            for (const [statType, enabled] of Object.entries(stats)) {
                if (enabled) {
                    const statInput = document.createElement('input');
                    statInput.type = 'hidden';
                    statInput.name = `col_statistics[${colVar}][${statType}]`;
                    statInput.value = 'on';
                    form.appendChild(statInput);
                }
            }
        }
    } catch (e) {
        console.error('Error parsing col_statistics:', e);
    }

    // 옵션
    {% if show_total %}
    const totalInput = document.createElement('input');
    totalInput.type = 'hidden';
    totalInput.name = 'show_total';
    totalInput.value = 'on';
    form.appendChild(totalInput);
    {% endif %}

    {% if auto_test %}
    const testInput = document.createElement('input');
    testInput.type = 'hidden';
    testInput.name = 'auto_test';
    testInput.value = 'on';
    form.appendChild(testInput);
    {% endif %}

    // 표시 형식 옵션
    const percentInput = document.createElement('input');
    percentInput.type = 'hidden';
    percentInput.name = 'percent_symbol';
    percentInput.value = '{{ percent_symbol }}';
    form.appendChild(percentInput);

    const decimalsInput = document.createElement('input');
    decimalsInput.type = 'hidden';
    decimalsInput.name = 'mean_decimals';
    decimalsInput.value = '{{ mean_decimals }}';
    form.appendChild(decimalsInput);

    // 카이제곱 표시 형식
    {% if show_chi_label %} form.appendChild(createInput('show_chi_label', 'on')); {% endif %}
    {% if show_chi_value %} form.appendChild(createInput('show_chi_value', 'on')); {% endif %}
    {% if show_chi_df %} form.appendChild(createInput('show_chi_df', 'on')); {% endif %}
    {% if show_chi_stars %} form.appendChild(createInput('show_chi_stars', 'on')); {% endif %}
    {% if show_chi_pvalue %} form.appendChild(createInput('show_chi_pvalue', 'on')); {% endif %}

    // t/F 검정 표시 형식
    {% if show_tf_label %} form.appendChild(createInput('show_tf_label', 'on')); {% endif %}
    {% if show_tf_value %} form.appendChild(createInput('show_tf_value', 'on')); {% endif %}
    {% if show_tf_df %} form.appendChild(createInput('show_tf_df', 'on')); {% endif %}
    {% if show_tf_stars %} form.appendChild(createInput('show_tf_stars', 'on')); {% endif %}
    {% if show_tf_pvalue %} form.appendChild(createInput('show_tf_pvalue', 'on')); {% endif %}

    document.body.appendChild(form);
    form.submit();

    // 폼 제거는 약간 지연
    setTimeout(() => {
        document.body.removeChild(form);
    }, 1000);
    }

    // 헬퍼 함수
    function createInput(name, value) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        return input;
    }
</script>
{% endblock %}